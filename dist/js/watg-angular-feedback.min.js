/*! watg-angular-feedback 2015-09-01 */
var watgFeedbackModule=angular.module("watgFeedback",["watgFeedback.templates","watgRichtext"]).config(function($httpProvider){$httpProvider.defaults.useXDomain=!0,delete $httpProvider.defaults.headers.common["X-Requested-With"]});watgFeedbackModule.directive("watgFeedback",function(watgFeedbackService){var controller=["$scope",function($scope){function updateStars(){$scope.stars=[];for(var i=0;i<$scope.max;i++)$scope.stars.push({filled:i<$scope.ratingValue})}$scope.header="Feedback",$scope.isBusySubmittingFeedback=!1,$scope.showConfirmation=!1,$scope.form={},$scope.max=5,$scope.stars=[],$scope.ratingValue=3,$scope.feebackContentResetCount=[],$scope.feedbackConfig={height:100,multiLine:!0,bootstrapCssPath:"public/css/vendor.min.css",showVariablesSelector:!0,showFontSelector:!0,showFontSizeSelector:!0,showColorSelector:!0,showBold:!0,showItalic:!0,showStrikeThrough:!0,showUnderline:!0,showUnorderedList:!0,showOrderedList:!0,showReduceIndent:!0,showIndent:!0,showLeftAlign:!0,showCenterAlign:!0,showRightAlign:!0,showJustify:!0,showUndo:!0,showRedo:!0,showInsertLink:!0,showRemoveLink:!0,showSourceCode:!1},$scope.attachmentMaxSize=209715.2,$scope.attachmentMaxImageHeight=1e3,$scope.attachmentMaxImageWidth=1e3,$scope.attachmentUploadIsBusy=!1,$scope.attachmentUploadMessages=[],$scope.appDevProjectUI={AppDevProjectId:0,AppDevProjectName:"",AppDevProjectDescription:"",AppDevProjectVersion:"",FeedbackContent:"",Vendor:"",Platform:"",UserAgent:"",ScreenResolution:"",Rating:null,Files:[]},$scope.getAppDevProjectByProjectName=function(){$scope.isBusy=!0,watgFeedbackService.getAppDevProjectByProjectName($scope.getUrl+"/"+$scope.projectName).then(function(result){$scope.appDevProjectUI.AppDevProjectId=result.AppDevProjectId,$scope.appDevProjectUI.AppDevProjectName=result.AppDevProjectName,$scope.appDevProjectUI.AppDevProjectDescription=result.AppDevProjectDescription,$scope.appDevProjectUI.AppDevProjectVersion=result.AppDevProjectVersion,$scope.isBusy=!1})},$scope.submitAppDevProjectFeedback=function(){$scope.isBusySubmittingFeedback=!0,$scope.appDevProjectUI.Vendor=navigator.appMinorVersion,$scope.appDevProjectUI.Platform=navigator.platform,$scope.appDevProjectUI.UserAgent=navigator.userAgent,$scope.appDevProjectUI.ScreenResolution=window.screen.availWidth+"*"+window.screen.availHeight,$scope.appDevProjectUI.Rating=$scope.ratingValue,$scope.urlReferrer&&($scope.appDevProjectUI.FeedbackContent+="<br />(Previous page) "+$scope.urlReferrer),watgFeedbackService.submitAppDevProjectFeedback($scope.appDevProjectUI,$scope.submitUrl).then(function(result){console.log(result);var transactionResult=result;transactionResult.HasError===!0&&console.error("Feedback Error "+transactionResult.Message),$scope.showConfirmation=!0,$scope.isBusySubmittingFeedback=!1})},$scope.toggle=function(index){$scope.ratingValue=index+1},$scope.$watch("ratingValue",function(oldValue,newValue){newValue&&updateStars()}),$scope.$watch("projectName",function(oldValue,newValue){newValue&&$scope.getAppDevProjectByProjectName()}),$scope.$watch("appDevProjectUI.FeedbackContent",function(newValue){""===newValue||"<br>"===newValue?$scope.form.inputForm.$setValidity("message",!1):$scope.form.inputForm.$setValidity("message",!0)}),$scope.getAppDevProjectByProjectName()}];return{restrict:"E",templateUrl:"app/templates/watgFeedbackTemplate.html",scope:{projectName:"=",getUrl:"=",submitUrl:"=",userFullName:"=",urlReferrer:"=",logsEnabled:"="},controller:controller,link:function(scope){scope.logsEnabled&&(console.log(scope.projectName),console.log(scope.getUrl),console.log(scope.submitUrl),console.log(scope.userFullName),console.log(scope.urlReferrer))}}}),watgFeedbackModule.directive("wgFileSelect",function(){return{restrict:"A",scope:{files:"=files",maxFileSize:"=maxFileSize",maxImageHeight:"=maxImageHeight",maxImageWidth:"=maxImageWidth",messages:"=",isBusy:"=",imageSrc:"="},link:function(scope,element){element.bind("change",function(e){scope.messages=[];var selectedFiles=(e.srcElement||e.target).files;if(selectedFiles)for(var i=0;i<selectedFiles.length;i++){scope.isBusy=!0,scope.$apply();var selectedFile=selectedFiles[i],reader=new FileReader,image=new Image;reader.readAsDataURL(selectedFile),reader.onload=function(theFile){return function(e){var isValid=!0;image.src=e.target.result,scope.imageSrc=image.src,image.height>scope.maxImageHeight&&(isValid=!1,scope.messages.push("Image "+theFile.name+" ("+image.height+"px) exceeds the max height limit of "+scope.maxImageHeight+"px.")),image.width>scope.maxImageWidth&&(isValid=!1,scope.messages.push("Image "+theFile.name+" ("+image.width+"px) exceeds the max width limit of "+scope.maxImageHeight+"px.")),theFile.size>scope.maxFileSize&&(isValid=!1,scope.messages.push("File "+theFile.name+" ("+(theFile.size/1048576).toFixed(2)+" MB) exceeds the max size limit of "+scope.maxFileSize/1048576+" MB.")),isValid&&scope.files.push(theFile),scope.isBusy=!1,scope.$apply()}}(selectedFile)}else scope.messages.push("File not found")})}}}),watgFeedbackModule.factory("watgFeedbackService",function($http){return{getAppDevProjectByProjectName:function(url){return console.log(url),$http({method:"GET",withCredentials:!0,url:url}).then(function(response){return response.data})},submitAppDevProjectFeedback:function(vm,url){console.log("Service 2 "+url);var formData=new FormData;formData.append("FeedbackContent",vm.FeedbackContent),formData.append("Vendor",vm.Vendor),formData.append("Platform",vm.Platform),formData.append("UserAgent",vm.UserAgent),formData.append("ScreenResolution",vm.ScreenResolution),formData.append("Rating",vm.Rating),formData.append("AppDevProjectId",vm.AppDevProjectId);for(var i=0;i<vm.Files.length;i++)formData.append("Files["+i+"]",vm.Files[i]);return $http({url:url,method:"POST",transformRequest:angular.identity,data:formData,withCredentials:!0,headers:{"Content-Type":void 0}}).then(function(response){return console.timeEnd("Posting Note"),response.data})}}});